name: Post-Merge Checks

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  unit-and-integration:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run tests with race detector and coverage
        run: go test -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: coverage.out
          flags: post-merge
          fail_ci_if_error: false

  generated-drift:
    name: Generated File Drift
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Regenerate CRDs/manifests
        run: make -f Makefile.operator generate manifests

      - name: Check for drift
        run: |
          if ! git diff --quiet; then
            echo "Generated files are out of date. Run 'make -f Makefile.operator generate manifests'."
            git diff
            exit 1
          fi

  kustomize-builds:
    name: Kustomize Build Sanity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install kustomize
        run: go install sigs.k8s.io/kustomize/kustomize/v5@latest

      - name: Build default manifests
        run: kustomize build config/default

      - name: Build registry manifests
        run: kustomize build config/registry

  build-binaries:
    name: Build CLI Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build Unix binaries
        run: make build-unix

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: mcp-runtime-binaries
          path: |
            bin/mcp-runtime-darwin-arm64
            bin/mcp-runtime-darwin-amd64
            bin/mcp-runtime-linux-arm64
            bin/mcp-runtime-linux-amd64

  operator-image:
    name: Operator Image Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build operator image (validation only)
        run: |
          docker build \
            --pull \
            -f Dockerfile.operator \
            .

  security-gosec:
    name: Gosec Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec
        run: $(go env GOPATH)/bin/gosec ./...

  security-trivy-fs:
    name: Trivy FS Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  security-trivy-image:
    name: Trivy Operator Image Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build operator image
        run: docker build --pull -f Dockerfile.operator -t mcp-runtime-operator:ci .

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: mcp-runtime-operator:ci
          vuln-type: 'os,library'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
