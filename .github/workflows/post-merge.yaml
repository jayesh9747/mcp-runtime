name: Post-Merge Checks

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  kustomize-builds:
    name: Kustomize Build Sanity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install kustomize
        run: go install sigs.k8s.io/kustomize/kustomize/v5@v5.8.0

      - name: Build default manifests
        run: kustomize build config/default

      - name: Build registry manifests
        run: kustomize build config/registry

  build-binaries:
    name: Build CLI Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build Unix binaries
        run: make build-unix

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: mcp-runtime-binaries
          path: |
            bin/mcp-runtime-darwin-arm64
            bin/mcp-runtime-darwin-amd64
            bin/mcp-runtime-linux-arm64
            bin/mcp-runtime-linux-amd64

  test-coverage:
    name: Unit + Integration Tests (Coverage)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install envtest
        run: |
          export KUBEBUILDER_ASSETS=$(go run sigs.k8s.io/controller-runtime/tools/setup-envtest@latest use -p path)
          echo "KUBEBUILDER_ASSETS=$KUBEBUILDER_ASSETS" >> $GITHUB_ENV

      - name: Run unit tests with coverage
        run: |
          go test -v -race -coverprofile=unit.out \
            $(go list ./... | grep -v '^github.com/Agent-Hellboy/mcp-runtime/test' | grep -v '^github.com/Agent-Hellboy/mcp-runtime/examples/example-app$')

      - name: Run integration tests with coverage
        run: |
          go test -v -race -timeout 30m -coverprofile=integration.out \
            -coverpkg=./internal/...,./pkg/...,./api/... \
            ./test/integration/...
        env:
          KUBEBUILDER_ASSETS: ${{ env.KUBEBUILDER_ASSETS }}

      - name: Merge coverage files
        run: |
          tail -n +2 integration.out >> unit.out
          mv unit.out coverage.out

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: post-merge
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run E2E tests (containerized)
        env:
          DOCKER_CONFIG: /tmp/docker-config
          DOCKER_BUILDKIT: "1"
        run: |
          chmod +x ./test/e2e/run-in-docker.sh
          ./test/e2e/run-in-docker.sh

  security-gosec:
    name: Gosec Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec
        run: $(go env GOPATH)/bin/gosec ./...

  security-trivy-fs:
    name: Trivy FS Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  security-trivy-image:
    name: Trivy Operator Image Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build operator image
        run: docker build --pull -f Dockerfile.operator -t mcp-runtime-operator:ci .

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: mcp-runtime-operator:ci
          vuln-type: 'os,library'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
