name: Pre-Check

on:
  pull_request:
    branches: [ "*" ]
  workflow_dispatch: {}

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install linters
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run go fmt check
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Code is not formatted. Run 'go fmt ./...'"
            gofmt -s -d .
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Run staticcheck
        run: staticcheck ./...

  test:
    name: Unit + Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install envtest
        run: |
          export KUBEBUILDER_ASSETS=$(go run sigs.k8s.io/controller-runtime/tools/setup-envtest@latest use -p path)
          echo "KUBEBUILDER_ASSETS=$KUBEBUILDER_ASSETS" >> $GITHUB_ENV

      - name: Run unit tests with coverage
        run: |
          go test -v -race -coverprofile=unit.out \
            $(go list ./... | grep -v '^github.com/Agent-Hellboy/mcp-runtime/test' | grep -v '^github.com/Agent-Hellboy/mcp-runtime/examples/example-app$')

      - name: Run integration tests with coverage
        run: |
          go test -v -race -timeout 30m -coverprofile=integration.out \
            -coverpkg=./internal/...,./pkg/...,./api/... \
            ./test/integration/...
        env:
          KUBEBUILDER_ASSETS: ${{ env.KUBEBUILDER_ASSETS }}

      - name: Merge coverage files
        run: |
          # Remove mode line from integration.out and append to unit.out
          tail -n +2 integration.out >> unit.out
          mv unit.out coverage.out

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: pre-merge
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  benchmark:
    name: Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run benchmarks
        run: |
          go test -run=^$ -bench=. -benchmem -count=1 ./test/benchmark/...

  generated-drift:
    name: Generated File Drift
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Regenerate CRDs/manifests
        run: make -f Makefile.operator generate manifests

      - name: Check for drift
        run: |
          if ! git diff --quiet; then
            echo "Generated files are out of date. Run 'make -f Makefile.operator generate manifests'."
            git diff
            exit 1
          fi
